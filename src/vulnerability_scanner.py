"""
Azure Vulnerability Scanner
Comprehensive security assessment for Azure resources
"""

import json
from datetime import datetime
from azure.mgmt.compute import ComputeManagementClient
from azure.mgmt.storage import StorageManagementClient
from azure.mgmt.network import NetworkManagementClient
from azure.mgmt.sql import SqlManagementClient
from azure.mgmt.security import SecurityCenter
from azure.core.exceptions import ResourceNotFoundError

class AzureVulnerabilityScanner:
    def __init__(self, credential, subscription_id):
        self.credential = credential
        self.subscription_id = subscription_id
        
        # Initialize Azure service clients
        self.compute_client = ComputeManagementClient(credential, subscription_id)
        self.storage_client = StorageManagementClient(credential, subscription_id)
        self.network_client = NetworkManagementClient(credential, subscription_id)
        self.sql_client = SqlManagementClient(credential, subscription_id)
        self.security_client = SecurityCenter(credential, subscription_id, "default")
    
    def scan_virtual_machines(self):
        """Scan virtual machines for security vulnerabilities"""
        print("    Scanning Virtual Machines...")
        vulnerabilities = []
        
        try:
            # Get all VMs in subscription
            vms = self.compute_client.virtual_machines.list_all()
            
            for vm in vms:
                vm_name = vm.name
                resource_group = vm.id.split('/')[4]
                
                # Check 1: Disk encryption
                if not self._check_disk_encryption(vm):
                    vulnerabilities.append({
                        'resource_type': 'Virtual Machine',
                        'resource_name': vm_name,
                        'resource_group': resource_group,
                        'vulnerability': 'Disk not encrypted',
                        'severity': 'High',
                        'description': 'Virtual machine disks should be encrypted for data protection',
                        'remediation': 'Enable Azure Disk Encryption'
                    })
                
                # Check 2: Network security
                network_issues = self._check_vm_network_security(vm, resource_group)
                vulnerabilities.extend(network_issues)
                
                # Check 3: Endpoint protection
                if not self._check_endpoint_protection(vm):
                    vulnerabilities.append({
                        'resource_type': 'Virtual Machine',
                        'resource_name': vm_name,
                        'resource_group': resource_group,
                        'vulnerability': 'No endpoint protection',
                        'severity': 'High',
                        'description': 'Virtual machine should have endpoint protection enabled',
                        'remediation': 'Install and configure endpoint protection'
                    })
                
                # Check 4: OS vulnerabilities
                os_issues = self._check_os_security(vm)
                vulnerabilities.extend(os_issues)
                
        except Exception as e:
            print(f"    [!] Error scanning VMs: {e}")
        
        return vulnerabilities
    
    def scan_storage_accounts(self):
        """Scan storage accounts for security misconfigurations"""
        print("    Scanning Storage Accounts...")
        vulnerabilities = []
        
        try:
            storage_accounts = self.storage_client.storage_accounts.list()
            
            for account in storage_accounts:
                account_name = account.name
                resource_group = account.id.split('/')[4]
                
                # Check 1: Public access
                if account.allow_blob_public_access:
                    vulnerabilities.append({
                        'resource_type': 'Storage Account',
                        'resource_name': account_name,
                        'resource_group': resource_group,
                        'vulnerability': 'Public blob access enabled',
                        'severity': 'High',
                        'description': 'Storage account allows public access to blobs',
                        'remediation': 'Disable public blob access'
                    })
                
                # Check 2: Encryption
                if not account.encryption:
                    vulnerabilities.append({
                        'resource_type': 'Storage Account',
                        'resource_name': account_name,
                        'resource_group': resource_group,
                        'vulnerability': 'Encryption not enabled',
                        'severity': 'High',
                        'description': 'Storage account encryption is not enabled',
                        'remediation': 'Enable storage service encryption'
                    })
                
                # Check 3: Network rules
                if account.network_rule_set and account.network_rule_set.default_action == "Allow":
                    vulnerabilities.append({
                        'resource_type': 'Storage Account',
                        'resource_name': account_name,
                        'resource_group': resource_group,
                        'vulnerability': 'Network access too permissive',
                        'severity': 'Medium',
                        'description': 'Storage account allows access from all networks',
                        'remediation': 'Restrict network access to specific IPs/VNets'
                    })
                
        except Exception as e:
            print(f"    [!] Error scanning storage accounts: {e}")
        
        return vulnerabilities
    
    def scan_network_security_groups(self):
        """Scan NSGs for insecure rules"""
        print("    Scanning Network Security Groups...")
        vulnerabilities = []
        
        try:
            nsgs = self.network_client.network_security_groups.list_all()
            
            for nsg in nsgs:
                nsg_name = nsg.name
                resource_group = nsg.id.split('/')[4]
                
                # Check security rules
                if nsg.security_rules:
                    for rule in nsg.security_rules:
                        if self._is_insecure_nsg_rule(rule):
                            vulnerabilities.append({
                                'resource_type': 'Network Security Group',
                                'resource_name': nsg_name,
                                'resource_group': resource_group,
                                'vulnerability': f'Insecure rule: {rule.name}',
                                'severity': 'High' if self._is_critical_rule(rule) else 'Medium',
                                'description': f'NSG rule allows {rule.direction} traffic from {rule.source_address_prefix} to port {rule.destination_port_range}',
                                'remediation': 'Review and restrict NSG rules'
                            })
                
        except Exception as e:
            print(f"    [!] Error scanning NSGs: {e}")
        
        return vulnerabilities
    
    def scan_sql_servers(self):
        """Scan SQL servers for security issues"""
        print("    Scanning SQL Servers...")
        vulnerabilities = []
        
        try:
            servers = self.sql_client.servers.list()
            
            for server in servers:
                server_name = server.name
                resource_group = server.id.split('/')[4]
                
                # Check 1: Azure AD authentication
                if not self._check_sql_aad_authentication(server):
                    vulnerabilities.append({
                        'resource_type': 'SQL Server',
                        'resource_name': server_name,
                        'resource_group': resource_group,
                        'vulnerability': 'Azure AD authentication not enabled',
                        'severity': 'Medium',
                        'description': 'SQL Server should use Azure AD authentication',
                        'remediation': 'Enable Azure AD authentication'
                    })
                
                # Check 2: TLS version
                if not self._check_sql_tls_version(server):
                    vulnerabilities.append({
                        'resource_type': 'SQL Server',
                        'resource_name': server_name,
                        'resource_group': resource_group,
                        'vulnerability': 'Outdated TLS version',
                        'severity': 'Medium',
                        'description': 'SQL Server should use TLS 1.2 or higher',
                        'remediation': 'Update TLS settings'
                    })
                
        except Exception as e:
            print(f"    [!] Error scanning SQL servers: {e}")
        
        return vulnerabilities
    
    def get_security_center_recommendations(self):
        """Get security recommendations from Azure Security Center"""
        print("    Fetching Azure Security Center recommendations...")
        vulnerabilities = []
        
        try:
            # Get secure score
            secure_scores = self.security_client.secure_scores.list()
            
            # Get recommendations
            recommendations = self.security_client.assessments.list()
            
            for recommendation in recommendations:
                if recommendation.status.code == "Unhealthy":
                    vulnerabilities.append({
                        'resource_type': 'Security Center',
                        'resource_name': recommendation.display_name,
                        'resource_group': 'N/A',
                        'vulnerability': recommendation.display_name,
                        'severity': self._map_severity(recommendation.severity),
                        'description': recommendation.description,
                        'remediation': 'Follow Security Center recommendation'
                    })
                    
        except Exception as e:
            print(f"    [!] Error fetching Security Center data: {e}")
        
        return vulnerabilities
    
    def _check_disk_encryption(self, vm):
        """Check if VM disks are encrypted"""
        # Simplified check - in production, verify encryption status
        return vm.storage_profile.os_disk.encryption_settings is not None
    
    def _check_vm_network_security(self, vm, resource_group):
        """Check VM network security configuration"""
        issues = []
        
        try:
            # Get network interfaces
            for nic_ref in vm.network_profile.network_interfaces:
                nic_name = nic_ref.id.split('/')[-1]
                nic = self.network_client.network_interfaces.get(resource_group, nic_name)
                
                # Check public IP
                for ip_config in nic.ip_configurations:
                    if ip_config.public_ip_address:
                        issues.append({
                            'resource_type': 'Virtual Machine',
                            'resource_name': vm.name,
                            'resource_group': resource_group,
                            'vulnerability': 'Public IP assigned',
                            'severity': 'Medium',
                            'description': 'Virtual machine has public IP address',
                            'remediation': 'Use private IP with bastion/jumpbox'
                        })
                        
        except Exception as e:
            print(f"        Error checking VM network: {e}")
        
        return issues
    
    def _check_endpoint_protection(self, vm):
        """Check if endpoint protection is enabled"""
        # Simplified check
        return True  # In production, check for endpoint protection extension
    
    def _check_os_security(self, vm):
        """Check OS-level security settings"""
        issues = []
        
        # Check for outdated OS
        if 'windows' in vm.storage_profile.os_disk.os_type.lower():
            if '2012' in vm.storage_profile.image_reference.offer if vm.storage_profile.image_reference else '':
                issues.append({
                    'resource_type': 'Virtual Machine',
                    'resource_name': vm.name,
                    'resource_group': vm.id.split('/')[4],
                    'vulnerability': 'Outdated Windows version',
                    'severity': 'High',
                    'description': 'Virtual machine is running outdated Windows version',
                    'remediation': 'Upgrade to supported Windows version'
                })
        
        return issues
    
    def _is_insecure_nsg_rule(self, rule):
        """Check if NSG rule is insecure"""
        if rule.direction.lower() != 'inbound':
            return False
        
        # Check for overly permissive source
        if rule.source_address_prefix in ['*', '0.0.0.0', '0.0.0.0/0', 'Internet']:
            # Check for dangerous ports
            if rule.destination_port_range in ['22', '3389', '1433', '5432']:
                return True
            if rule.destination_port_range == '*' or rule.destination_port_range == '1-65535':
                return True
        
        return False
    
    def _is_critical_rule(self, rule):
        """Check if NSG rule is critical"""
        critical_ports = ['22', '3389', '1433', '5432', '5900', '5985', '5986']
        return rule.destination_port_range in critical_ports
    
    def _check_sql_aad_authentication(self, server):
        """Check if SQL server has Azure AD authentication enabled"""
        # Simplified check
        return True  # In production, check actual AAD settings
    
    def _check_sql_tls_version(self, server):
        """Check SQL server TLS version"""
        # Simplified check
        return True  # In production, check TLS settings
    
    def _map_severity(self, security_center_severity):
        """Map Security Center severity to our levels"""
        severity_map = {
            'High': 'High',
            'Medium': 'Medium', 
            'Low': 'Low'
        }
        return severity_map.get(security_center_severity, 'Medium')
